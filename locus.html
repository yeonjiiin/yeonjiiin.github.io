<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCUS Game Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .card-selected {
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            transform: translateY(-1rem) scale(1.05);
            z-index: 10;
        }

        .block-unit {
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 2px;
        }

        .rainbow-bg {
            background: linear-gradient(135deg, #ef4444, #f59e0b, #3b82f6, #10b981);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .animate-pop {
            animation: fadeIn 0.2s ease-out forwards;
        }
    </style>
</head>
<body>

<div id="app">
    <!-- 셋업 화면 -->
    <div id="setup-screen" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center animate-pop">
            <h1 class="text-4xl font-black text-slate-800 mb-2 tracking-tight">LOCUS</h1>
            <p class="text-slate-500 mb-8 font-medium">보드게임 딜러 어시스턴트</p>
            <div class="mb-8">
                <label class="block text-slate-700 font-bold mb-4">플레이어 수</label>
                <div class="flex justify-center gap-2 sm:gap-4" id="player-count-selector">
                    <button onclick="setPlayerCount(2)" class="player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-slate-200 text-slate-600 transition-all">2</button>
                    <button onclick="setPlayerCount(3)" class="player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-blue-600 text-white scale-110 shadow-lg">3</button>
                    <button onclick="setPlayerCount(4)" class="player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-slate-200 text-slate-600 transition-all">4</button>
                    <button onclick="setPlayerCount(5)" class="player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-slate-200 text-slate-600 transition-all">5</button>
                </div>
            </div>
            <div class="mb-8 p-4 bg-blue-50 rounded-xl">
                <p id="round-info-text" class="text-blue-700 font-bold">3인 플레이: 총 5라운드 진행</p>
            </div>
            <button onclick="initGame()" class="w-full py-4 bg-slate-800 text-white rounded-xl text-lg font-bold hover:bg-slate-700 transition-all active:scale-95">
                게임 시작
            </button>
        </div>
    </div>

    <!-- 메인 게임 화면 -->
    <div id="game-screen" class="hidden flex flex-col min-h-screen">
        <header class="bg-white border-b border-slate-200 p-4 sticky top-0 z-10 shadow-sm">
            <div class="max-w-4xl mx-auto flex justify-between items-end">
                <div class="flex flex-col">
                    <span id="round-label" class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Current Round</span>
                    <div class="flex items-baseline gap-2">
                        <span id="current-round-display" class="text-3xl font-black text-slate-800">1</span>
                        <span id="max-round-display" class="text-slate-300 font-bold text-lg">/ 5</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="bg-slate-100 px-2 py-1.5 rounded-lg flex items-center gap-1.5">
                        <i class="fa-solid fa-layer-group text-slate-500 text-xs"></i>
                        <span id="deck-count" class="text-xs font-bold text-slate-700">0</span>
                    </div>
                    <div id="selection-status" class="px-2 py-1.5 rounded-lg flex items-center gap-1.5 bg-blue-100 text-blue-700 transition-colors">
                        <i class="fa-solid fa-users text-xs"></i>
                        <span id="selection-count" class="text-xs font-bold">0/3</span>
                    </div>
                    
                    <button onclick="openResetModal()" class="p-2.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all group border border-transparent hover:border-red-100">
                        <i class="fa-solid fa-rotate-left text-xl group-active:rotate-[-90deg] transition-transform duration-300"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 p-6 flex flex-col items-center justify-center max-w-6xl mx-auto w-full">
            <div id="history-alert" class="hidden mb-6 bg-orange-100 text-orange-700 px-4 py-2 rounded-full font-bold text-sm flex items-center gap-2 animate-pulse">
                <i class="fa-solid fa-clock-rotate-left"></i> 과거 라운드 기록을 확인 중입니다.
            </div>

            <div id="card-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                <!-- 카드가 동적으로 생성됨 -->
            </div>
        </main>

        <footer class="bg-white p-6 border-t border-slate-200 shadow-lg sticky bottom-0">
            <div class="max-w-xl mx-auto flex gap-4">
                <button id="prev-btn" onclick="showPreviousRound()" disabled class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-slate-200 disabled:opacity-30 transition-all">
                    <i class="fa-solid fa-chevron-left"></i> PREV
                </button>

                <button id="next-btn" onclick="handleNextAction()" disabled class="flex-[2] py-4 bg-slate-100 text-slate-300 rounded-2xl text-xl font-black flex items-center justify-center gap-3 transition-all">
                    NEXT ROUND
                </button>
            </div>
        </footer>
    </div>

    <!-- 커스텀 리셋 모달 -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-pop">
            <div class="flex items-center gap-3 text-red-600 mb-4">
                <i class="fa-solid fa-triangle-exclamation text-xl"></i>
                <h3 class="text-lg font-bold">게임 초기화</h3>
            </div>
            <p class="text-slate-600 mb-6 leading-relaxed">
                현재 진행 중인 게임이 모두 사라집니다.<br/>
                정말로 인원 선택 화면으로 돌아갈까요?
            </p>
            <div class="flex gap-3">
                <button onclick="closeResetModal()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">취소</button>
                <button onclick="performReset()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors shadow-lg shadow-red-200">초기화 확인</button>
            </div>
        </div>
    </div>

    <!-- 게임 종료 모달 -->
    <div id="ended-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[90] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full text-center animate-pop">
            <i class="fa-solid fa-trophy text-6xl text-yellow-500 mb-4"></i>
            <h2 class="text-3xl font-bold text-slate-800 mb-4">게임 종료</h2>
            <p class="text-slate-600 mb-8 font-medium text-lg">지정된 라운드가 모두 완료되었습니다.<br/>최종 점수를 확인하세요!</p>
            <button onclick="performReset()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all flex items-center justify-center gap-2 shadow-lg">
                <i class="fa-solid fa-house"></i> 메인으로 이동
            </button>
        </div>
    </div>
</div>

<script>
    // --- 인원별 라운드 설정 ---
    const ROUND_LIMITS = {
        2: 8,
        3: 5,
        4: 4,
        5: 3
    };

    // --- 카드 데이터 정의 ---
    const REGULAR_SHAPES = {
        shape_1: [[1, 1], [1, 0], [1, 1]],
        shape_2: [[1, 1, 1], [0, 1, 0], [0, 1, 0]],
        shape_3: [[1, 1, 0], [0, 1, 0], [0, 1, 1]],
        shape_4: [[0, 0, 1], [0, 1, 1], [1, 1, 0]],
        shape_5: [[0, 0, 1], [1, 1, 1], [0, 1, 0]],
        shape_6: [[0, 0, 1], [0, 0, 1], [1, 1, 1]],
        shape_7: [[1, 1, 1]],
        shape_8: [[1, 0], [1, 1]]
    };
    const RAINBOW_SHAPES = {
        joker_1: [[1, 1, 1], [0, 1, 0]],
        joker_2: [[1, 1, 1], [0, 0, 1]],
        joker_3: [[0, 1, 1], [1, 1, 0]],
        joker_4: [[1, 1]]
    };
    const COLORS = [
        { name: 'Yellow', hex: '#FACC15' },
        { name: 'Purple', hex: '#A855F7' },
        { name: 'Red', hex: '#EF4444' },
        { name: 'Green', hex: '#22C55E' },
        { name: 'Blue', hex: '#3B82F6' }
    ];

    // --- 게임 상태 ---
    let playerCount = 3;
    let deck = [];
    let currentCards = [];
    let selectedCardIds = [];
    let round = 1;
    let history = [];
    let viewingHistoryIndex = -1;

    // --- 인원 선택 로직 (2~5인) ---
    function setPlayerCount(num) {
        playerCount = num;
        document.querySelectorAll('.player-btn').forEach(btn => {
            if (parseInt(btn.innerText) === num) {
                btn.className = "player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-blue-600 text-white scale-110 shadow-lg";
            } else {
                btn.className = "player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-slate-200 text-slate-600 transition-all";
            }
        });
        document.getElementById('round-info-text').innerText = `${num}인 플레이: 총 ${ROUND_LIMITS[num]}라운드 진행`;
    }

    // --- 게임 초기화 로직 ---
    function initGame() {
        deck = [];
        let idCounter = 0;

        COLORS.forEach(color => {
            Object.keys(REGULAR_SHAPES).forEach(key => {
                deck.push({
                    id: idCounter++,
                    shape: REGULAR_SHAPES[key],
                    color: color.hex,
                    isRainbow: false,
                    hasCoin: ['shape_7', 'shape_8'].includes(key)
                });
            });
        });

        Object.keys(RAINBOW_SHAPES).forEach(key => {
            for (let i = 0; i < 2; i++) {
                deck.push({
                    id: idCounter++,
                    shape: RAINBOW_SHAPES[key],
                    color: 'rainbow',
                    isRainbow: true,
                    hasCoin: key === 'joker_4'
                });
            }
        });

        // 셔플
        deck.sort(() => Math.random() - 0.5);

        // 첫 드로우: 인원수 + 1장
        currentCards = deck.splice(0, playerCount + 1);
        selectedCardIds = [];
        round = 1;
        history = [];
        viewingHistoryIndex = -1;

        updateUI();
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('ended-modal').classList.add('hidden');
    }

    function performReset() {
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('setup-screen').classList.remove('hidden');
        document.getElementById('reset-modal').classList.add('hidden');
        document.getElementById('ended-modal').classList.add('hidden');
    }

    function openResetModal() { document.getElementById('reset-modal').classList.remove('hidden'); }
    function closeResetModal() { document.getElementById('reset-modal').classList.add('hidden'); }

    // --- 라운드 제어 ---
    function handleNextAction() {
        if (viewingHistoryIndex !== -1) {
            if (viewingHistoryIndex === history.length - 1) {
                viewingHistoryIndex = -1;
            } else {
                viewingHistoryIndex++;
            }
            updateUI();
            return;
        }

        if (selectedCardIds.length < playerCount) return;

        history.push({
            round: round,
            cards: [...currentCards],
            selectedIds: [...selectedCardIds]
        });

        // 지정된 라운드 종료 확인
        if (round >= ROUND_LIMITS[playerCount]) {
            document.getElementById('ended-modal').classList.remove('hidden');
            return;
        }

        // 덱 소진 확인 (안전장치)
        if (deck.length < playerCount + 1) {
            document.getElementById('ended-modal').classList.remove('hidden');
            return;
        }

        currentCards = deck.splice(0, playerCount + 1);
        selectedCardIds = [];
        round++;
        updateUI();
    }

    function showPreviousRound() {
        if (viewingHistoryIndex === -1) {
            viewingHistoryIndex = history.length - 1;
        } else if (viewingHistoryIndex > 0) {
            viewingHistoryIndex--;
        }
        updateUI();
    }

    // --- 카드 렌더링 ---
    function renderCard(card) {
        const isSelected = (viewingHistoryIndex === -1 ? selectedCardIds : history[viewingHistoryIndex].selectedIds).includes(card.id);
        const isHistoryView = viewingHistoryIndex !== -1;
        const isRoundComplete = !isHistoryView && selectedCardIds.length === playerCount;
        const isDimmed = !isSelected && (isHistoryView || isRoundComplete);

        const cardBtn = document.createElement('button');
        cardBtn.className = `relative w-36 h-52 sm:w-40 sm:h-56 rounded-2xl border-2 transition-all duration-300 transform flex flex-col items-center justify-between py-8 bg-white ${isSelected ? 'card-selected' : 'border-slate-200'} ${isDimmed ? 'opacity-30 grayscale-[0.5] blur-[0.5px]' : 'opacity-100'}`;
        
        if (!isHistoryView && (!isRoundComplete || isSelected)) {
            cardBtn.onclick = () => toggleCard(card.id);
        }

        const shapeContainer = document.createElement('div');
        shapeContainer.className = "relative";
        const rows = card.shape.length;
        const cols = card.shape[0].length;
        const size = 16;
        const pad = 2;
        shapeContainer.style.width = `${cols * (size + pad)}px`;
        shapeContainer.style.height = `${rows * (size + pad)}px`;

        card.shape.forEach((row, rIdx) => {
            row.forEach((cell, cIdx) => {
                if (cell === 1) {
                    const block = document.createElement('div');
                    block.className = `block-unit absolute ${card.color === 'rainbow' ? 'rainbow-bg' : ''}`;
                    block.style.width = `${size}px`;
                    block.style.height = `${size}px`;
                    block.style.left = `${cIdx * (size + pad)}px`;
                    block.style.top = `${rIdx * (size + pad)}px`;
                    if (card.color !== 'rainbow') block.style.backgroundColor = card.color;
                    shapeContainer.appendChild(block);
                }
            });
        });

        cardBtn.innerHTML = `<div class="h-4"></div>`;
        cardBtn.appendChild(shapeContainer);
        
        const footer = document.createElement('div');
        footer.className = "h-8 flex items-center justify-center";
        if (card.hasCoin) {
            footer.innerHTML = `<div class="bg-yellow-100 p-1.5 rounded-full border border-yellow-200 shadow-sm"><i class="fa-solid fa-coins text-yellow-600"></i></div>`;
        }
        cardBtn.appendChild(footer);

        if (isSelected) {
            const check = document.createElement('div');
            check.className = "absolute top-3 right-3 bg-blue-500 text-white rounded-full p-1 shadow-md w-6 h-6 flex items-center justify-center text-[10px]";
            check.innerHTML = `<i class="fa-solid fa-check"></i>`;
            cardBtn.appendChild(check);
        }

        return cardBtn;
    }

    function toggleCard(id) {
        const idx = selectedCardIds.indexOf(id);
        if (idx > -1) {
            selectedCardIds.splice(idx, 1);
        } else if (selectedCardIds.length < playerCount) {
            selectedCardIds.push(id);
        }
        updateUI();
    }

    function updateUI() {
        const isHistory = viewingHistoryIndex !== -1;
        const dispRound = isHistory ? history[viewingHistoryIndex].round : round;
        const dispCards = isHistory ? history[viewingHistoryIndex].cards : currentCards;
        const dispSelCount = isHistory ? history[viewingHistoryIndex].selectedIds.length : selectedCardIds.length;

        document.getElementById('current-round-display').innerText = dispRound;
        document.getElementById('current-round-display').className = `text-3xl font-black ${isHistory ? 'text-orange-500' : 'text-slate-800'}`;
        document.getElementById('round-label').innerText = isHistory ? `Viewing Round ${dispRound}` : 'Current Round';
        document.getElementById('max-round-display').innerText = `/ ${ROUND_LIMITS[playerCount]}`;
        document.getElementById('deck-count').innerText = deck.length;
        document.getElementById('selection-count').innerText = `${dispSelCount}/${playerCount}`;
        
        const statusBox = document.getElementById('selection-status');
        if (dispSelCount === playerCount) {
            statusBox.className = "px-2 py-1.5 rounded-lg flex items-center gap-1.5 bg-green-100 text-green-700";
        } else {
            statusBox.className = "px-2 py-1.5 rounded-lg flex items-center gap-1.5 bg-blue-100 text-blue-700";
        }

        document.getElementById('history-alert').style.display = isHistory ? 'flex' : 'none';

        const container = document.getElementById('card-container');
        container.innerHTML = '';
        dispCards.forEach(card => container.appendChild(renderCard(card)));

        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');

        prevBtn.disabled = (isHistory && viewingHistoryIndex === 0) || (!isHistory && history.length === 0);

        if (isHistory) {
            nextBtn.innerText = viewingHistoryIndex === history.length - 1 ? 'BACK TO CURRENT' : 'NEXT HISTORY';
            nextBtn.className = "flex-[2] py-4 bg-orange-500 text-white rounded-2xl text-xl font-black flex items-center justify-center gap-3 hover:bg-orange-600 shadow-lg transition-all";
            nextBtn.disabled = false;
        } else {
            nextBtn.innerText = round === ROUND_LIMITS[playerCount] ? 'FINISH GAME' : 'NEXT ROUND';
            const ready = selectedCardIds.length === playerCount;
            nextBtn.disabled = !ready;
            nextBtn.className = `flex-[2] py-4 rounded-2xl text-xl font-black flex items-center justify-center gap-3 transition-all ${ready ? 'bg-slate-900 text-white hover:bg-slate-800 shadow-xl' : 'bg-slate-100 text-slate-300'}`;
        }
    }
</script>

</body>
</html>
