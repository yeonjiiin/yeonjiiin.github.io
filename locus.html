<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCUS Game Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Quicksand', sans-serif;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* 별 배경 효과 */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            z-index: -1;
            opacity: 0.6;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-base {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(99, 102, 241, 0.3);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-selected {
            border-color: #facc15; /* 노란색 강조 */
            background: rgba(30, 41, 59, 0.9);
            box-shadow: 0 0 20px rgba(250, 204, 21, 0.4);
            transform: translateY(-0.75rem) scale(1.05);
            z-index: 10;
        }

        /* 블록 스타일 - 네온 느낌 */
        .block-unit {
            border-radius: 4px;
            box-shadow: inset 0 0 4px rgba(0,0,0,0.2), 0 0 4px rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .rainbow-bg {
            background: linear-gradient(135deg, #ef4444, #f59e0b, #10b981, #3b82f6, #8b5cf6);
            background-size: 200% 200%;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes popIn {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .animate-pop {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .reshuffle-toast {
            animation: slideUp 0.5s ease-out forwards;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* 버튼 스타일 오버라이드 */
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #8b5cf6);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
        }
        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.6);
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #94a3b8;
        }
        .btn-secondary:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
            color: white;
        }
    </style>
</head>
<body>

<div id="app">
    <!-- Setup Screen -->
    <div id="setup-screen" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="glass-panel p-8 rounded-3xl shadow-2xl max-w-md w-full text-center animate-pop">
            <div class="mb-4 inline-block p-3 rounded-full bg-indigo-500/20">
                <i class="fa-solid fa-rocket text-4xl text-indigo-400"></i>
            </div>
            <h1 class="text-5xl font-bold text-white mb-2 tracking-tight drop-shadow-md">LOCUS</h1>
            <p class="text-indigo-200 mb-8 font-medium">Board Game Dealer Assistant</p>
            
            <div class="mb-8">
                <label class="block text-indigo-100 font-bold mb-4 text-lg">플레이어 수 설정</label>
                <div class="flex justify-center gap-3" id="player-count-selector">
                    <button onclick="setPlayerCount(2)" class="player-btn w-14 h-14 rounded-2xl text-xl font-bold bg-slate-700 text-slate-400 transition-all border border-slate-600 hover:bg-slate-600">2</button>
                    <button onclick="setPlayerCount(3)" class="player-btn w-14 h-14 rounded-2xl text-xl font-bold bg-indigo-500 text-white scale-110 shadow-lg border border-indigo-400 shadow-indigo-500/50">3</button>
                    <button onclick="setPlayerCount(4)" class="player-btn w-14 h-14 rounded-2xl text-xl font-bold bg-slate-700 text-slate-400 transition-all border border-slate-600 hover:bg-slate-600">4</button>
                    <button onclick="setPlayerCount(5)" class="player-btn w-14 h-14 rounded-2xl text-xl font-bold bg-slate-700 text-slate-400 transition-all border border-slate-600 hover:bg-slate-600">5</button>
                </div>
            </div>
            
            <div class="mb-8 p-4 bg-indigo-900/30 rounded-2xl border border-indigo-500/20">
                <p id="round-info-text" class="text-indigo-200 font-medium text-sm">3인 플레이 시작합니다.</p>
            </div>
            
            <button onclick="initGame()" class="w-full py-4 btn-primary text-white rounded-2xl text-lg font-bold transition-all active:scale-95">
                START GAME
            </button>
        </div>
    </div>

    <!-- Main Game Screen -->
    <div id="game-screen" class="hidden flex flex-col min-h-screen">
        <header class="glass-panel border-b-0 p-4 sticky top-0 z-20 shadow-lg">
            <div class="max-w-5xl mx-auto flex justify-between items-end">
                <div class="flex flex-col">
                    <span id="round-label" class="text-[11px] text-indigo-300 font-bold uppercase tracking-widest mb-1">Status</span>
                    <div class="flex flex-col">
                        <div class="flex items-baseline gap-2">
                            <span id="current-round-display" class="text-4xl font-bold text-white drop-shadow-sm">1</span>
                            <span class="text-indigo-300 font-bold text-lg">ROUND</span>
                        </div>
                        <div id="turn-progress-dots" class="flex gap-1.5 mt-2">
                            <!-- Turn dots -->
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="bg-slate-800/80 px-3 py-2 rounded-xl flex items-center gap-2 border border-slate-600">
                        <i class="fa-solid fa-layer-group text-indigo-400 text-sm"></i>
                        <span id="deck-count" class="text-sm font-bold text-slate-200">0</span>
                    </div>
                    <div id="selection-status" class="px-3 py-2 rounded-xl flex items-center gap-2 bg-indigo-500/20 border border-indigo-500/30 text-indigo-200 transition-colors">
                        <i class="fa-solid fa-check-double text-sm"></i>
                        <span id="selection-count" class="text-sm font-bold">0/0</span>
                    </div>
                    
                    <button onclick="openResetModal()" class="p-3 text-slate-400 hover:text-red-400 hover:bg-red-500/10 rounded-xl transition-all group">
                        <i class="fa-solid fa-rotate-left text-xl group-active:rotate-[-90deg] transition-transform duration-300"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 p-6 flex flex-col items-center justify-center max-w-6xl mx-auto w-full overflow-x-hidden relative z-10">
            <div id="history-alert" class="hidden mb-6 bg-amber-500/20 border border-amber-500/40 text-amber-200 px-5 py-2.5 rounded-full font-bold text-sm flex items-center gap-2 animate-pulse">
                <i class="fa-solid fa-clock-rotate-left"></i> 과거 기록을 확인 중입니다.
            </div>

            <div id="card-container" class="flex flex-wrap justify-center gap-6 pb-24">
                <!-- Cards generated here -->
            </div>
        </main>

        <footer class="glass-panel p-6 border-t-0 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] sticky bottom-0 z-20">
            <div class="max-w-xl mx-auto flex flex-col gap-4">
                <div id="turn-instruction" class="text-center text-sm font-bold text-indigo-200 uppercase tracking-wide">
                    Player 1
                </div>
                <div class="flex gap-4">
                    <button id="prev-btn" onclick="showPreviousRound()" disabled class="flex-1 py-4 btn-secondary rounded-2xl font-bold flex items-center justify-center gap-2 disabled:opacity-30 transition-all">
                        <i class="fa-solid fa-chevron-left"></i> PREV
                    </button>

                    <button id="next-btn" onclick="handleNextAction()" disabled class="flex-[2] py-4 btn-primary text-white rounded-2xl text-xl font-bold flex items-center justify-center gap-3 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        CONFIRM
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Reshuffle Toast -->
    <div id="reshuffle-toast" class="hidden fixed bottom-32 left-1/2 -translate-x-1/2 z-[100] reshuffle-toast">
        <div class="glass-panel bg-slate-900/90 text-indigo-200 px-6 py-4 rounded-full shadow-2xl flex items-center gap-3 border border-indigo-500/50">
            <i class="fa-solid fa-arrows-rotate animate-spin text-indigo-400"></i>
            <span class="font-bold text-sm">덱 소진! 사용된 카드를 다시 섞습니다.</span>
        </div>
    </div>

    <!-- Reset Modal -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-panel bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center animate-pop border-slate-600">
            <div class="mb-4 inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-500/20 text-red-400">
                <i class="fa-solid fa-triangle-exclamation text-3xl"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">게임 초기화</h3>
            <p class="text-slate-300 mb-8 leading-relaxed text-sm">
                모든 진행 상황이 우주 저편으로 사라집니다.<br/>
                설정 화면으로 돌아갈까요?
            </p>
            <div class="flex gap-3">
                <button onclick="closeResetModal()" class="flex-1 py-3 btn-secondary rounded-2xl font-bold transition-colors">취소</button>
                <button onclick="performReset()" class="flex-1 py-3 bg-red-500/80 hover:bg-red-500 text-white rounded-2xl font-bold transition-colors shadow-lg shadow-red-500/30">초기화</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Data Definitions ---
    const REGULAR_SHAPES = {
        shape_1: [[1, 1], [1, 0], [1, 1]],
        shape_2: [[1, 1, 1], [0, 1, 0], [0, 1, 0]],
        shape_3: [[1, 1, 0], [0, 1, 0], [0, 1, 1]],
        shape_4: [[0, 0, 1], [0, 1, 1], [1, 1, 0]],
        shape_5: [[0, 0, 1], [1, 1, 1], [0, 1, 0]],
        shape_6: [[0, 0, 1], [0, 0, 1], [1, 1, 1]],
        shape_7: [[1, 1, 1]],
        shape_8: [[1, 0], [1, 1]]
    };
    const RAINBOW_SHAPES = {
        joker_1: [[1, 1, 1], [0, 1, 0]],
        joker_2: [[1, 1, 1], [0, 0, 1]],
        joker_3: [[0, 1, 1], [1, 1, 0]],
        joker_4: [[1, 1]]
    };
    // Updated bright neon colors
    const COLORS = [
        { name: 'Yellow', hex: '#facc15' }, // Yellow-400
        { name: 'Purple', hex: '#c084fc' }, // Purple-400
        { name: 'Red', hex: '#f87171' },    // Red-400
        { name: 'Green', hex: '#4ade80' },  // Green-400
        { name: 'Blue', hex: '#60a5fa' }    // Blue-400
    ];

    let playerCount = 3;
    let deck = [];
    let currentCards = [];
    let selectedCardIds = []; 
    let currentTurnInRound = 0; 
    let round = 1;
    let history = [];
    let viewingHistoryIndex = -1;

    function getRequiredSelectionCount() {
        return playerCount;
    }

    function getDrawCount() {
        return playerCount + 1;
    }

    function setPlayerCount(num) {
        playerCount = num;
        document.querySelectorAll('.player-btn').forEach(btn => {
            if (parseInt(btn.innerText) === num) {
                btn.className = "player-btn w-14 h-14 rounded-2xl text-xl font-bold bg-indigo-500 text-white scale-110 shadow-lg border border-indigo-400 shadow-indigo-500/50 transition-all";
            } else {
                btn.className = "player-btn w-14 h-14 rounded-2xl text-xl font-bold bg-slate-700 text-slate-400 transition-all border border-slate-600 hover:bg-slate-600";
            }
        });
        const info = document.getElementById('round-info-text');
        info.innerText = `${num}인 플레이 시작합니다.`;
    }

    function createFullDeck() {
        let tempDeck = [];
        let idCounter = 0;
        COLORS.forEach(color => {
            Object.keys(REGULAR_SHAPES).forEach(key => {
                tempDeck.push({
                    id: idCounter++,
                    shape: REGULAR_SHAPES[key],
                    color: color.hex,
                    isRainbow: false,
                    hasCoin: ['shape_7', 'shape_8'].includes(key)
                });
            });
        });
        Object.keys(RAINBOW_SHAPES).forEach(key => {
            for (let i = 0; i < 2; i++) {
                tempDeck.push({
                    id: idCounter++,
                    shape: RAINBOW_SHAPES[key],
                    color: 'rainbow',
                    isRainbow: true,
                    hasCoin: key === 'joker_4'
                });
            }
        });
        return tempDeck.sort(() => Math.random() - 0.5);
    }

    function drawCards() {
        const targetCount = getDrawCount();
        let nextCards = [];

        if (deck.length < targetCount) {
            nextCards = [...deck];
            deck = [];
            let usedCards = [];
            history.forEach(h => usedCards.push(...h.cards));
            const currentIds = currentCards.map(c => c.id);
            deck = usedCards.filter(c => !currentIds.includes(c.id)).sort(() => Math.random() - 0.5);
            const needed = targetCount - nextCards.length;
            nextCards.push(...deck.splice(0, needed));
            showReshuffleToast();
        } else {
            nextCards = deck.splice(0, targetCount);
        }
        return nextCards;
    }

    function initGame() {
        deck = createFullDeck();
        currentCards = []; 
        currentCards = drawCards();
        selectedCardIds = [];
        currentTurnInRound = 0;
        round = 1;
        history = [];
        viewingHistoryIndex = -1;

        updateUI();
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
    }

    function performReset() {
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('setup-screen').classList.remove('hidden');
        document.getElementById('reset-modal').classList.add('hidden');
    }

    function openResetModal() { document.getElementById('reset-modal').classList.remove('hidden'); }
    function closeResetModal() { document.getElementById('reset-modal').classList.add('hidden'); }

    function handleNextAction() {
        if (viewingHistoryIndex !== -1) {
            if (viewingHistoryIndex === history.length - 1) {
                viewingHistoryIndex = -1;
            } else {
                viewingHistoryIndex++;
            }
            updateUI();
            return;
        }

        if (selectedCardIds.length < getRequiredSelectionCount()) return;

        history.push({
            round: round,
            turn: currentTurnInRound + 1,
            cards: [...currentCards],
            selectedIds: [...selectedCardIds],
            reqCount: getRequiredSelectionCount()
        });

        currentTurnInRound++;

        if (currentTurnInRound >= playerCount) {
            round++;
            currentTurnInRound = 0;
        }

        currentCards = drawCards();
        selectedCardIds = [];
        updateUI();
    }

    function showReshuffleToast() {
        const toast = document.getElementById('reshuffle-toast');
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function showPreviousRound() {
        if (viewingHistoryIndex === -1) {
            viewingHistoryIndex = history.length - 1;
        } else if (viewingHistoryIndex > 0) {
            viewingHistoryIndex--;
        }
        updateUI();
    }

    function renderCard(card) {
        const reqCount = viewingHistoryIndex === -1 ? getRequiredSelectionCount() : history[viewingHistoryIndex].reqCount;
        const isSelected = (viewingHistoryIndex === -1 ? selectedCardIds : history[viewingHistoryIndex].selectedIds).includes(card.id);
        const isHistoryView = viewingHistoryIndex !== -1;
        const isFull = !isHistoryView && selectedCardIds.length >= reqCount;
        const isDimmed = !isSelected && (isHistoryView || isFull);

        const cardBtn = document.createElement('button');
        // Updated card styles for dark theme
        const baseClasses = `relative w-32 h-48 sm:w-36 sm:h-52 md:w-40 md:h-56 rounded-3xl transition-all duration-300 transform flex flex-col items-center justify-between py-6 sm:py-8 card-base`;
        const selectedClasses = isSelected ? 'card-selected' : '';
        const dimmedClasses = isDimmed ? 'opacity-30 blur-[1px] grayscale-[0.3]' : 'opacity-100';
        
        cardBtn.className = `${baseClasses} ${selectedClasses} ${dimmedClasses}`;
        
        if (!isHistoryView) {
            cardBtn.onclick = () => toggleCard(card.id);
        }

        const shapeContainer = document.createElement('div');
        shapeContainer.className = "relative";
        const rows = card.shape.length;
        const cols = card.shape[0].length;
        const size = 14;
        const pad = 2;
        shapeContainer.style.width = `${cols * (size + pad)}px`;
        shapeContainer.style.height = `${rows * (size + pad)}px`;

        card.shape.forEach((row, rIdx) => {
            row.forEach((cell, cIdx) => {
                if (cell === 1) {
                    const block = document.createElement('div');
                    block.className = `block-unit absolute ${card.color === 'rainbow' ? 'rainbow-bg' : ''}`;
                    block.style.width = `${size}px`;
                    block.style.height = `${size}px`;
                    block.style.left = `${cIdx * (size + pad)}px`;
                    block.style.top = `${rIdx * (size + pad)}px`;
                    if (card.color !== 'rainbow') block.style.backgroundColor = card.color;
                    shapeContainer.appendChild(block);
                }
            });
        });

        cardBtn.innerHTML = `<div class="h-4"></div>`;
        cardBtn.appendChild(shapeContainer);
        
        const footer = document.createElement('div');
        footer.className = "h-8 flex items-center justify-center";
        if (card.hasCoin) {
            footer.innerHTML = `<div class="bg-yellow-500/20 p-1.5 rounded-full border border-yellow-400/50 shadow-[0_0_10px_rgba(250,204,21,0.3)]"><i class="fa-solid fa-coins text-yellow-400 text-sm"></i></div>`;
        }
        cardBtn.appendChild(footer);

        if (isSelected) {
            const check = document.createElement('div');
            check.className = "absolute top-3 right-3 bg-indigo-500 text-white rounded-full p-1.5 shadow-lg w-7 h-7 flex items-center justify-center text-xs";
            check.innerHTML = `<i class="fa-solid fa-check"></i>`;
            cardBtn.appendChild(check);
        }

        return cardBtn;
    }

    function toggleCard(id) {
        const reqCount = getRequiredSelectionCount();
        const idx = selectedCardIds.indexOf(id);
        
        if (idx > -1) {
            selectedCardIds.splice(idx, 1);
        } else {
            if (selectedCardIds.length < reqCount) {
                selectedCardIds.push(id);
            }
        }
        updateUI();
    }

    function updateUI() {
        const isHistory = viewingHistoryIndex !== -1;
        const dispRound = isHistory ? history[viewingHistoryIndex].round : round;
        const dispTurn = isHistory ? history[viewingHistoryIndex].turn : currentTurnInRound + 1;
        const dispCards = isHistory ? history[viewingHistoryIndex].cards : currentCards;
        const dispSelCount = isHistory ? history[viewingHistoryIndex].selectedIds.length : selectedCardIds.length;
        const reqCount = isHistory ? history[viewingHistoryIndex].reqCount : getRequiredSelectionCount();

        document.getElementById('current-round-display').innerText = dispRound;
        document.getElementById('current-round-display').className = `text-4xl font-bold drop-shadow-sm ${isHistory ? 'text-amber-400' : 'text-white'}`;
        document.getElementById('round-label').innerText = isHistory ? `기록 확인: Round ${dispRound}` : '현재 라운드';
        document.getElementById('deck-count').innerText = deck.length;
        document.getElementById('selection-count').innerText = `${dispSelCount}/${reqCount}`;
        
        const statusBox = document.getElementById('selection-status');
        if (dispSelCount === reqCount) {
            statusBox.className = "px-3 py-2 rounded-xl flex items-center gap-2 bg-green-500/20 border border-green-500/30 text-green-200 transition-colors";
        } else {
            statusBox.className = "px-3 py-2 rounded-xl flex items-center gap-2 bg-indigo-500/20 border border-indigo-500/30 text-indigo-200";
        }

        const dotsContainer = document.getElementById('turn-progress-dots');
        dotsContainer.innerHTML = '';
        for (let i = 0; i < playerCount; i++) {
            const dot = document.createElement('div');
            const turnIndex = isHistory ? dispTurn - 1 : currentTurnInRound;
            const isActive = i < turnIndex;
            const isCurrent = i === turnIndex;
            // Updated dot colors for dark theme
            dot.className = `h-2 rounded-full transition-all duration-300 ${isCurrent ? 'w-6 bg-indigo-400 shadow-[0_0_8px_rgba(129,140,248,0.6)]' : (isActive ? 'w-2 bg-indigo-800' : 'w-2 bg-slate-700')}`;
            dotsContainer.appendChild(dot);
        }

        const instruction = document.getElementById('turn-instruction');
        if (isHistory) {
            instruction.innerText = `Player ${dispTurn} (기록 확인)`;
            instruction.className = "text-center text-sm font-bold text-amber-400 uppercase tracking-wide";
        } else {
            instruction.innerText = `Player ${dispTurn}`;
            instruction.className = "text-center text-sm font-bold text-indigo-200 uppercase tracking-wide";
        }

        document.getElementById('history-alert').style.display = isHistory ? 'flex' : 'none';

        const container = document.getElementById('card-container');
        container.innerHTML = '';
        dispCards.forEach(card => container.appendChild(renderCard(card)));

        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');

        prevBtn.disabled = (isHistory && viewingHistoryIndex === 0) || (!isHistory && history.length === 0);

        if (isHistory) {
            nextBtn.innerText = viewingHistoryIndex === history.length - 1 ? 'BACK TO GAME' : 'NEXT HISTORY';
            nextBtn.className = "flex-[2] py-4 bg-amber-500 hover:bg-amber-600 text-white rounded-2xl text-xl font-bold flex items-center justify-center gap-3 shadow-lg shadow-amber-900/20 transition-all";
            nextBtn.disabled = false;
        } else {
            const ready = selectedCardIds.length === reqCount;
            nextBtn.innerText = 'CONFIRM';
            nextBtn.disabled = !ready;
            // Updated button styles
            nextBtn.className = `flex-[2] py-4 rounded-2xl text-xl font-bold flex items-center justify-center gap-3 transition-all ${ready ? 'btn-primary text-white shadow-lg cursor-pointer' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`;
        }
    }
</script>

</body>
</html>