<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOCUS Game Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .card-selected {
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            transform: translateY(-1rem) scale(1.05);
            z-index: 10;
        }

        .block-unit {
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 2px;
        }

        .rainbow-bg {
            background: linear-gradient(135deg, #ef4444, #f59e0b, #3b82f6, #10b981);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .animate-pop {
            animation: fadeIn 0.2s ease-out forwards;
        }

        .reshuffle-toast {
            animation: slideUp 0.5s ease-out forwards;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

<div id="app">
    <!-- Setup Screen -->
    <div id="setup-screen" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center animate-pop">
            <h1 class="text-4xl font-black text-slate-800 mb-2 tracking-tight">LOCUS</h1>
            <p class="text-slate-500 mb-8 font-medium">Board Game Dealer Assistant</p>
            <div class="mb-8">
                <label class="block text-slate-700 font-bold mb-4">플레이어 수 설정</label>
                <div class="flex justify-center gap-2 sm:gap-4" id="player-count-selector">
                    <button onclick="setPlayerCount(2)" class="player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-slate-200 text-slate-600 transition-all">2</button>
                    <button onclick="setPlayerCount(3)" class="player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-blue-600 text-white scale-110 shadow-lg">3</button>
                    <button onclick="setPlayerCount(4)" class="player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-slate-200 text-slate-600 transition-all">4</button>
                    <button onclick="setPlayerCount(5)" class="player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-slate-200 text-slate-600 transition-all">5</button>
                </div>
            </div>
            <div class="mb-8 p-4 bg-slate-50 rounded-xl">
                <p id="round-info-text" class="text-slate-600 font-medium text-sm">3인 플레이 시작합니다.</p>
            </div>
            <button onclick="initGame()" class="w-full py-4 bg-slate-800 text-white rounded-xl text-lg font-bold hover:bg-slate-700 transition-all active:scale-95">
                START GAME
            </button>
        </div>
    </div>

    <!-- Main Game Screen -->
    <div id="game-screen" class="hidden flex flex-col min-h-screen">
        <header class="bg-white border-b border-slate-200 p-4 sticky top-0 z-10 shadow-sm">
            <div class="max-w-4xl mx-auto flex justify-between items-end">
                <div class="flex flex-col">
                    <span id="round-label" class="text-[10px] text-slate-400 font-black uppercase tracking-widest mb-1">Status</span>
                    <div class="flex flex-col">
                        <div class="flex items-baseline gap-2">
                            <span id="current-round-display" class="text-3xl font-black text-slate-800">1</span>
                            <span class="text-slate-400 font-bold text-lg">ROUND</span>
                        </div>
                        <div id="turn-progress-dots" class="flex gap-1 mt-1">
                            <!-- Turn dots -->
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="bg-slate-100 px-2 py-1.5 rounded-lg flex items-center gap-1.5">
                        <i class="fa-solid fa-layer-group text-slate-500 text-xs"></i>
                        <span id="deck-count" class="text-xs font-bold text-slate-700">0</span>
                    </div>
                    <div id="selection-status" class="px-2 py-1.5 rounded-lg flex items-center gap-1.5 bg-blue-100 text-blue-700 transition-colors">
                        <i class="fa-solid fa-check-double text-xs"></i>
                        <span id="selection-count" class="text-xs font-bold">0/0</span>
                    </div>
                    
                    <button onclick="openResetModal()" class="p-2.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all group border border-transparent hover:border-red-100">
                        <i class="fa-solid fa-rotate-left text-xl group-active:rotate-[-90deg] transition-transform duration-300"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 p-6 flex flex-col items-center justify-center max-w-6xl mx-auto w-full overflow-x-hidden">
            <div id="history-alert" class="hidden mb-6 bg-orange-100 text-orange-700 px-4 py-2 rounded-full font-bold text-sm flex items-center gap-2 animate-pulse">
                <i class="fa-solid fa-clock-rotate-left"></i> 과거 기록을 확인 중입니다.
            </div>

            <div id="card-container" class="flex flex-wrap justify-center gap-4 sm:gap-6">
                <!-- Cards generated here -->
            </div>
        </main>

        <footer class="bg-white p-6 border-t border-slate-200 shadow-lg sticky bottom-0">
            <div class="max-w-xl mx-auto flex flex-col gap-3">
                <div id="turn-instruction" class="text-center text-sm font-black text-slate-800 uppercase tracking-wide">
                    Player 1
                </div>
                <div class="flex gap-4">
                    <button id="prev-btn" onclick="showPreviousRound()" disabled class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-slate-200 disabled:opacity-30 transition-all">
                        <i class="fa-solid fa-chevron-left"></i> PREV
                    </button>

                    <button id="next-btn" onclick="handleNextAction()" disabled class="flex-[2] py-4 bg-slate-100 text-slate-300 rounded-2xl text-xl font-black flex items-center justify-center gap-3 transition-all">
                        CONFIRM
                    </button>
                </div>
            </div>
        </footer>
    </div>

    <!-- Reshuffle Toast -->
    <div id="reshuffle-toast" class="hidden fixed bottom-28 left-1/2 -translate-x-1/2 z-[100] reshuffle-toast">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-slate-600">
            <i class="fa-solid fa-arrows-rotate animate-spin text-blue-400"></i>
            <span class="font-bold text-sm">덱 소진! 사용된 카드를 다시 섞습니다.</span>
        </div>
    </div>

    <!-- Reset Modal -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-pop">
            <div class="flex items-center gap-3 text-red-600 mb-4">
                <i class="fa-solid fa-triangle-exclamation text-xl"></i>
                <h3 class="text-lg font-bold">게임 초기화</h3>
            </div>
            <p class="text-slate-600 mb-6 leading-relaxed">
                모든 진행 상황이 삭제됩니다.<br/>
                설정 화면으로 돌아갈까요?
            </p>
            <div class="flex gap-3">
                <button onclick="closeResetModal()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-200 transition-colors">취소</button>
                <button onclick="performReset()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-colors shadow-lg shadow-red-200">초기화</button>
            </div>
        </div>
    </div>
</div>

<script>
    const REGULAR_SHAPES = {
        shape_1: [[1, 1], [1, 0], [1, 1]],
        shape_2: [[1, 1, 1], [0, 1, 0], [0, 1, 0]],
        shape_3: [[1, 1, 0], [0, 1, 0], [0, 1, 1]],
        shape_4: [[0, 0, 1], [0, 1, 1], [1, 1, 0]],
        shape_5: [[0, 0, 1], [1, 1, 1], [0, 1, 0]],
        shape_6: [[0, 0, 1], [0, 0, 1], [1, 1, 1]],
        shape_7: [[1, 1, 1]],
        shape_8: [[1, 0], [1, 1]]
    };
    const RAINBOW_SHAPES = {
        joker_1: [[1, 1, 1], [0, 1, 0]],
        joker_2: [[1, 1, 1], [0, 0, 1]],
        joker_3: [[0, 1, 1], [1, 1, 0]],
        joker_4: [[1, 1]]
    };
    const COLORS = [
        { name: 'Yellow', hex: '#FACC15' },
        { name: 'Purple', hex: '#A855F7' },
        { name: 'Red', hex: '#EF4444' },
        { name: 'Green', hex: '#22C55E' },
        { name: 'Blue', hex: '#3B82F6' }
    ];

    let playerCount = 3;
    let deck = [];
    let currentCards = [];
    let selectedCardIds = []; 
    let currentTurnInRound = 0; 
    let round = 1;
    let history = [];
    let viewingHistoryIndex = -1;

    function getRequiredSelectionCount() {
        return playerCount;
    }

    function getDrawCount() {
        return playerCount + 1;
    }

    function setPlayerCount(num) {
        playerCount = num;
        document.querySelectorAll('.player-btn').forEach(btn => {
            if (parseInt(btn.innerText) === num) {
                btn.className = "player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-blue-600 text-white scale-110 shadow-lg";
            } else {
                btn.className = "player-btn w-14 h-14 sm:w-16 sm:h-16 rounded-full text-xl font-bold bg-slate-200 text-slate-600 transition-all";
            }
        });
        const info = document.getElementById('round-info-text');
        info.innerText = `${num}인 플레이 시작합니다.`;
    }

    function createFullDeck() {
        let tempDeck = [];
        let idCounter = 0;
        COLORS.forEach(color => {
            Object.keys(REGULAR_SHAPES).forEach(key => {
                tempDeck.push({
                    id: idCounter++,
                    shape: REGULAR_SHAPES[key],
                    color: color.hex,
                    isRainbow: false,
                    hasCoin: ['shape_7', 'shape_8'].includes(key)
                });
            });
        });
        Object.keys(RAINBOW_SHAPES).forEach(key => {
            for (let i = 0; i < 2; i++) {
                tempDeck.push({
                    id: idCounter++,
                    shape: RAINBOW_SHAPES[key],
                    color: 'rainbow',
                    isRainbow: true,
                    hasCoin: key === 'joker_4'
                });
            }
        });
        return tempDeck.sort(() => Math.random() - 0.5);
    }

    function drawCards() {
        const targetCount = getDrawCount();
        let nextCards = [];

        if (deck.length < targetCount) {
            nextCards = [...deck];
            deck = [];
            let usedCards = [];
            history.forEach(h => usedCards.push(...h.cards));
            const currentIds = currentCards.map(c => c.id);
            deck = usedCards.filter(c => !currentIds.includes(c.id)).sort(() => Math.random() - 0.5);
            const needed = targetCount - nextCards.length;
            nextCards.push(...deck.splice(0, needed));
            showReshuffleToast();
        } else {
            nextCards = deck.splice(0, targetCount);
        }
        return nextCards;
    }

    function initGame() {
        deck = createFullDeck();
        currentCards = []; 
        currentCards = drawCards();
        selectedCardIds = [];
        currentTurnInRound = 0;
        round = 1;
        history = [];
        viewingHistoryIndex = -1;

        updateUI();
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
    }

    function performReset() {
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('setup-screen').classList.remove('hidden');
        document.getElementById('reset-modal').classList.add('hidden');
    }

    function openResetModal() { document.getElementById('reset-modal').classList.remove('hidden'); }
    function closeResetModal() { document.getElementById('reset-modal').classList.add('hidden'); }

    function handleNextAction() {
        if (viewingHistoryIndex !== -1) {
            if (viewingHistoryIndex === history.length - 1) {
                viewingHistoryIndex = -1;
            } else {
                viewingHistoryIndex++;
            }
            updateUI();
            return;
        }

        if (selectedCardIds.length < getRequiredSelectionCount()) return;

        history.push({
            round: round,
            turn: currentTurnInRound + 1,
            cards: [...currentCards],
            selectedIds: [...selectedCardIds],
            reqCount: getRequiredSelectionCount()
        });

        currentTurnInRound++;

        if (currentTurnInRound >= playerCount) {
            round++;
            currentTurnInRound = 0;
        }

        currentCards = drawCards();
        selectedCardIds = [];
        updateUI();
    }

    function showReshuffleToast() {
        const toast = document.getElementById('reshuffle-toast');
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function showPreviousRound() {
        if (viewingHistoryIndex === -1) {
            viewingHistoryIndex = history.length - 1;
        } else if (viewingHistoryIndex > 0) {
            viewingHistoryIndex--;
        }
        updateUI();
    }

    function renderCard(card) {
        const reqCount = viewingHistoryIndex === -1 ? getRequiredSelectionCount() : history[viewingHistoryIndex].reqCount;
        const isSelected = (viewingHistoryIndex === -1 ? selectedCardIds : history[viewingHistoryIndex].selectedIds).includes(card.id);
        const isHistoryView = viewingHistoryIndex !== -1;
        const isFull = !isHistoryView && selectedCardIds.length >= reqCount;
        const isDimmed = !isSelected && (isHistoryView || isFull);

        const cardBtn = document.createElement('button');
        cardBtn.className = `relative w-32 h-48 sm:w-36 sm:h-52 md:w-40 md:h-56 rounded-2xl border-2 transition-all duration-300 transform flex flex-col items-center justify-between py-6 sm:py-8 bg-white ${isSelected ? 'card-selected' : 'border-slate-200'} ${isDimmed ? 'opacity-30 grayscale-[0.5] blur-[0.5px]' : 'opacity-100'}`;
        
        if (!isHistoryView) {
            cardBtn.onclick = () => toggleCard(card.id);
        }

        const shapeContainer = document.createElement('div');
        shapeContainer.className = "relative";
        const rows = card.shape.length;
        const cols = card.shape[0].length;
        const size = 14;
        const pad = 2;
        shapeContainer.style.width = `${cols * (size + pad)}px`;
        shapeContainer.style.height = `${rows * (size + pad)}px`;

        card.shape.forEach((row, rIdx) => {
            row.forEach((cell, cIdx) => {
                if (cell === 1) {
                    const block = document.createElement('div');
                    block.className = `block-unit absolute ${card.color === 'rainbow' ? 'rainbow-bg' : ''}`;
                    block.style.width = `${size}px`;
                    block.style.height = `${size}px`;
                    block.style.left = `${cIdx * (size + pad)}px`;
                    block.style.top = `${rIdx * (size + pad)}px`;
                    if (card.color !== 'rainbow') block.style.backgroundColor = card.color;
                    shapeContainer.appendChild(block);
                }
            });
        });

        cardBtn.innerHTML = `<div class="h-4"></div>`;
        cardBtn.appendChild(shapeContainer);
        
        const footer = document.createElement('div');
        footer.className = "h-8 flex items-center justify-center";
        if (card.hasCoin) {
            footer.innerHTML = `<div class="bg-yellow-100 p-1 rounded-full border border-yellow-200 shadow-sm"><i class="fa-solid fa-coins text-yellow-600 text-xs"></i></div>`;
        }
        cardBtn.appendChild(footer);

        if (isSelected) {
            const check = document.createElement('div');
            check.className = "absolute top-3 right-3 bg-blue-500 text-white rounded-full p-1 shadow-md w-6 h-6 flex items-center justify-center text-[10px]";
            check.innerHTML = `<i class="fa-solid fa-check"></i>`;
            cardBtn.appendChild(check);
        }

        return cardBtn;
    }

    function toggleCard(id) {
        const reqCount = getRequiredSelectionCount();
        const idx = selectedCardIds.indexOf(id);
        
        if (idx > -1) {
            selectedCardIds.splice(idx, 1);
        } else {
            if (selectedCardIds.length < reqCount) {
                selectedCardIds.push(id);
            }
        }
        updateUI();
    }

    function updateUI() {
        const isHistory = viewingHistoryIndex !== -1;
        const dispRound = isHistory ? history[viewingHistoryIndex].round : round;
        const dispTurn = isHistory ? history[viewingHistoryIndex].turn : currentTurnInRound + 1;
        const dispCards = isHistory ? history[viewingHistoryIndex].cards : currentCards;
        const dispSelCount = isHistory ? history[viewingHistoryIndex].selectedIds.length : selectedCardIds.length;
        const reqCount = isHistory ? history[viewingHistoryIndex].reqCount : getRequiredSelectionCount();

        document.getElementById('current-round-display').innerText = dispRound;
        document.getElementById('current-round-display').className = `text-3xl font-black ${isHistory ? 'text-orange-500' : 'text-slate-800'}`;
        document.getElementById('round-label').innerText = isHistory ? `기록 확인: Round ${dispRound}` : '현재 라운드';
        document.getElementById('deck-count').innerText = deck.length;
        document.getElementById('selection-count').innerText = `${dispSelCount}/${reqCount}`;
        
        const statusBox = document.getElementById('selection-status');
        if (dispSelCount === reqCount) {
            statusBox.className = "px-2 py-1.5 rounded-lg flex items-center gap-1.5 bg-green-100 text-green-700";
        } else {
            statusBox.className = "px-2 py-1.5 rounded-lg flex items-center gap-1.5 bg-blue-100 text-blue-700";
        }

        const dotsContainer = document.getElementById('turn-progress-dots');
        dotsContainer.innerHTML = '';
        for (let i = 0; i < playerCount; i++) {
            const dot = document.createElement('div');
            const turnIndex = isHistory ? dispTurn - 1 : currentTurnInRound;
            const isActive = i < turnIndex;
            const isCurrent = i === turnIndex;
            dot.className = `h-1.5 rounded-full transition-all duration-300 ${isCurrent ? 'w-4 bg-blue-500' : (isActive ? 'w-1.5 bg-blue-200' : 'w-1.5 bg-slate-200')}`;
            dotsContainer.appendChild(dot);
        }

        const instruction = document.getElementById('turn-instruction');
        if (isHistory) {
            instruction.innerText = `Player ${dispTurn} (기록 확인)`;
            instruction.className = "text-center text-sm font-black text-orange-500 uppercase tracking-wide";
        } else {
            instruction.innerText = `Player ${dispTurn}`;
            instruction.className = "text-center text-sm font-black text-slate-800 uppercase tracking-wide";
        }

        document.getElementById('history-alert').style.display = isHistory ? 'flex' : 'none';

        const container = document.getElementById('card-container');
        container.innerHTML = '';
        dispCards.forEach(card => container.appendChild(renderCard(card)));

        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');

        prevBtn.disabled = (isHistory && viewingHistoryIndex === 0) || (!isHistory && history.length === 0);

        if (isHistory) {
            nextBtn.innerText = viewingHistoryIndex === history.length - 1 ? 'BACK TO GAME' : 'NEXT HISTORY';
            nextBtn.className = "flex-[2] py-4 bg-orange-500 text-white rounded-2xl text-xl font-black flex items-center justify-center gap-3 hover:bg-orange-600 shadow-lg transition-all";
            nextBtn.disabled = false;
        } else {
            const ready = selectedCardIds.length === reqCount;
            nextBtn.innerText = 'CONFIRM';
            nextBtn.disabled = !ready;
            nextBtn.className = `flex-[2] py-4 rounded-2xl text-xl font-black flex items-center justify-center gap-3 transition-all ${ready ? 'bg-slate-900 text-white hover:bg-slate-800 shadow-xl' : 'bg-slate-100 text-slate-300'}`;
        }
    }
</script>

</body>
</html>